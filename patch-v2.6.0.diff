diff --git a/src/App.jsx b/src/App.jsx
index 1234567..abcdefg 100644
--- a/src/App.jsx
+++ b/src/App.jsx
@@ -1,4 +1,4 @@
-import { HashRouter as Router, Routes, Route } from 'react-router-dom'
+import { HashRouter as Router, Routes, Route, Navigate } from 'react-router-dom'
 import { Toaster } from 'react-hot-toast'
 import Layout from './components/Layout'
 import Dashboard from './pages/Dashboard'
@@ -50,6 +50,12 @@ function App() {
         {/* Public routes */}
         <Route path="/portail/:token" element={<TraineePortal />} />
         <Route path="/reclamation" element={<Reclamation />} />
+        
+        {/* Legacy public routes - redirect to secure portal */}
+        <Route path="/emargement/:token" element={<LegacyRedirect />} />
+        <Route path="/fiche-renseignement/:token" element={<LegacyRedirect />} />
+        <Route path="/evaluation-chaud/:token" element={<LegacyRedirect />} />
+        <Route path="/questionnaire/:token" element={<LegacyRedirect />} />
       </Routes>
       <Toaster position="top-right" />
     </Router>
@@ -57,4 +63,12 @@ function App() {
   )
 }
 
+function LegacyRedirect() {
+  const { token } = useParams()
+  return <Navigate to={`/portail/${token}`} replace />
+}
+
+import { useParams } from 'react-router-dom'
+
 export default App
diff --git a/src/pages/public/TraineePortal.jsx b/src/pages/public/TraineePortal.jsx
index 1234567..abcdefg 100644
--- a/src/pages/public/TraineePortal.jsx
+++ b/src/pages/public/TraineePortal.jsx
@@ -3,7 +3,7 @@ import { useParams } from 'react-router-dom'
 import { supabase } from '../../lib/supabase'
 import {
   User, GraduationCap, FileText, CheckCircle, AlertCircle, Loader2, Calendar,
-  Star, Clock, MapPin, Building
+  Star, Clock, MapPin, Building, KeyRound, Lock, ShieldCheck
 } from 'lucide-react'
 import { format, parseISO, eachDayOfInterval, isToday, isBefore, startOfDay } from 'date-fns'
 import { fr } from 'date-fns/locale'
@@ -16,8 +16,15 @@ export default function TraineePortal() {
   const [session, setSession] = useState(null)
   const [trainees, setTrainees] = useState([])
   const [selectedTrainee, setSelectedTrainee] = useState(null)
-  const [currentStep, setCurrentStep] = useState('select')
+  const [currentStep, setCurrentStep] = useState('select') // select | code | info_sheet | attendance | evaluation | thank_you
 
+  // Code verification state
+  const [portalToken, setPortalToken] = useState(null)
+  const [codeInput, setCodeInput] = useState('')
+  const [codeError, setCodeError] = useState(null)
+  const [codeLoading, setCodeLoading] = useState(false)
+  const [remainingAttempts, setRemainingAttempts] = useState(5)
+
   // Form states
   const [infoSheet, setInfoSheet] = useState(null)
   const [infoForm, setInfoForm] = useState({})
@@ -33,55 +40,67 @@ export default function TraineePortal() {
 
   useEffect(() => { loadSession() }, [token])
 
+  // Format code input as XXX-XXX
+  const formatCodeInput = (value) => {
+    const digits = value.replace(/\D/g, '').slice(0, 6)
+    if (digits.length > 3) {
+      return digits.slice(0, 3) + '-' + digits.slice(3)
+    }
+    return digits
+  }
+
   const loadSession = async () => {
     try {
-      const { data: sessionData, error } = await supabase
-        .from('sessions')
-        .select(`
-          *,
-          courses(id, title, objectives, duration_days, duration_hours),
-          clients(id, name),
-          session_trainees(
-            trainee_id,
-            trainees(id, first_name, last_name, email, phone, birth_date, social_security_number, refused_ssn, csp, job_title)
-          )
-        `)
-        .eq('attendance_token', token)
-        .single()
-
-      if (error || !sessionData) {
-        setError('Session non trouvée ou lien invalide')
+      const { data, error: rpcError } = await supabase.rpc('public_verify_portal_session', {
+        p_attendance_token: token
+      })
+
+      if (rpcError) {
+        console.error('RPC error:', rpcError)
+        setError('Erreur de connexion')
         setLoading(false)
         return
       }
 
-      // Check expiration (J+7)
-      const endDate = new Date(sessionData.end_date)
-      const expirationDate = new Date(endDate)
-      expirationDate.setDate(expirationDate.getDate() + 7)
-      expirationDate.setHours(23, 59, 59, 999)
-
-      if (new Date() > expirationDate) {
-        setError('Le portail d\'émargement a expiré (J+7 après la fin de la session)')
+      if (!data?.success) {
+        if (data?.error === 'SESSION_EXPIRED') {
+          setError('Le portail a expiré (J+7 après la fin de session)')
+        } else {
+          setError('Session non trouvée ou lien invalide')
+        }
         setLoading(false)
         return
       }
 
-      setSession(sessionData)
-
-      // Extract trainees list
-      const traineesList = sessionData.session_trainees
-        ?.map(st => st.trainees)
-        .filter(Boolean)
-        .sort((a, b) => a.last_name.localeCompare(b.last_name)) || []
-
-      setTrainees(traineesList)
+      setSession(data.session)
+      setTrainees(data.trainees || [])
       setLoading(false)
     } catch (err) {
-      console.error(err)
+      console.error('Load session error:', err)
       setError('Une erreur est survenue')
       setLoading(false)
     }
   }
 
-  const handleSelectTrainee = async (trainee) => {
+  const handleSelectTrainee = (trainee) => {
+    if (trainee.locked) {
+      setCodeError('Ce compte est bloqué. Veuillez contacter le formateur.')
+      return
+    }
     setSelectedTrainee(trainee)
-    await loadTraineeData(trainee.id)
+    setCodeInput('')
+    setCodeError(null)
+    setRemainingAttempts(5)
+    setCurrentStep('code')
+  }
+
+  const handleVerifyCode = async () => {
+    const cleanCode = codeInput.replace(/\D/g, '')
+    if (cleanCode.length !== 6) {
+      setCodeError('Le code doit contenir 6 chiffres')
+      return
+    }
+
+    setCodeLoading(true)
+    setCodeError(null)
+
+    try {
+      const { data, error: rpcError } = await supabase.rpc('public_verify_trainee_code', {
+        p_attendance_token: token,
+        p_trainee_id: selectedTrainee.id,
+        p_code: cleanCode
+      })
+
+      if (rpcError) {
+        setCodeError('Erreur de connexion')
+        setCodeLoading(false)
+        return
+      }
+
+      if (!data?.success) {
+        if (data?.error === 'ACCOUNT_LOCKED') {
+          setCodeError('Compte bloqué après 5 tentatives. Contactez le formateur.')
+          setTrainees(prev => prev.map(t =>
+            t.id === selectedTrainee.id ? { ...t, locked: true } : t
+          ))
+        } else if (data?.error === 'INVALID_CODE') {
+          const remaining = data.remaining_attempts || 0
+          setRemainingAttempts(remaining)
+          setCodeError(`Code incorrect. ${remaining} tentative${remaining > 1 ? 's' : ''} restante${remaining > 1 ? 's' : ''}.`)
+        } else {
+          setCodeError('Code invalide')
+        }
+        setCodeLoading(false)
+        return
+      }
+
+      // Success - store portal token and load profile
+      setPortalToken(data.portal_token)
+      await loadTraineeProfile(data.portal_token)
+
+    } catch (err) {
+      console.error('Verify code error:', err)
+      setCodeError('Une erreur est survenue')
+      setCodeLoading(false)
+    }
   }
 
-  const loadTraineeData = async (traineeId) => {
+  const loadTraineeProfile = async (pToken) => {
     try {
-      // Load info sheet
-      const { data: infoData } = await supabase
-        .from('trainee_info_sheets')
-        .select('*')
-        .eq('session_id', session.id)
-        .eq('trainee_id', traineeId)
-        .maybeSingle()
-
-      if (infoData) {
-        setInfoSheet(infoData)
-        setInfoForm({
-          first_name: selectedTrainee.first_name || '',
-          last_name: selectedTrainee.last_name || '',
-          email: infoData.email || selectedTrainee.email || '',
-          birth_date: selectedTrainee.birth_date || '',
-          ssn: infoData.ssn || selectedTrainee.social_security_number || '',
-          ssn_refused: infoData.ssn_refused || selectedTrainee.refused_ssn || false,
-          last_training_year: infoData.last_training_year || '',
-          highest_diploma: infoData.highest_diploma || '',
-          csp: infoData.csp || selectedTrainee.csp || '',
-          job_title: infoData.job_title || selectedTrainee.job_title || '',
-          rgpd_consent: infoData.rgpd_consent || false,
-        })
-      } else {
-        setInfoForm({
-          first_name: selectedTrainee.first_name || '',
-          last_name: selectedTrainee.last_name || '',
-          email: selectedTrainee.email || '',
-          birth_date: selectedTrainee.birth_date || '',
-          ssn: selectedTrainee.social_security_number || '',
-          ssn_refused: selectedTrainee.refused_ssn || false,
-          last_training_year: '',
-          highest_diploma: '',
-          csp: selectedTrainee.csp || '',
-          job_title: selectedTrainee.job_title || '',
-          rgpd_consent: false,
-        })
+      const { data, error: rpcError } = await supabase.rpc('public_get_portal_profile', {
+        p_portal_token: pToken
+      })
+
+      if (rpcError || !data?.success) {
+        setError('Erreur lors du chargement du profil')
+        setCodeLoading(false)
+        return
       }
 
-      // Load attendance
-      const { data: attData } = await supabase
-        .from('attendance_halfdays')
-        .select('*')
-        .eq('session_id', session.id)
-        .eq('trainee_id', traineeId)
+      const { trainee, session: sess, info_sheet, attendances, evaluation } = data
+
+      // Update trainee data
+      setSelectedTrainee(trainee)
+
+      // Update session if needed
+      if (sess) {
+        setSession(prev => ({ ...prev, ...sess }))
+      }
 
+      // Setup info form
+      setInfoSheet(info_sheet)
+      setInfoForm({
+        first_name: trainee.first_name || '',
+        last_name: trainee.last_name || '',
+        email: info_sheet?.email || trainee.email || '',
+        birth_date: trainee.birth_date || '',
+        ssn: info_sheet?.ssn || trainee.social_security_number || '',
+        ssn_refused: info_sheet?.ssn_refused ?? trainee.refused_ssn ?? false,
+        last_training_year: info_sheet?.last_training_year || '',
+        highest_diploma: info_sheet?.highest_diploma || '',
+        csp: info_sheet?.csp || trainee.csp || '',
+        job_title: info_sheet?.job_title || trainee.job_title || '',
+        rgpd_consent: info_sheet?.rgpd_consent || false,
+      })
+
+      // Setup attendance data
       const attMap = {}
-      attData?.forEach(a => {
-        if (a.morning) attMap[`${a.date}_morning`] = true
-        if (a.afternoon) attMap[`${a.date}_afternoon`] = true
+      ;(attendances || []).forEach(a => {
+        const dateStr = typeof a.date === 'string' ? a.date.substring(0, 10) : a.date
+        if (a.morning) attMap[`${dateStr}_morning`] = true
+        if (a.afternoon) attMap[`${dateStr}_afternoon`] = true
       })
       setAttendanceData(attMap)
 
-      // Load evaluation
-      const { data: evalData } = await supabase
-        .from('trainee_evaluations')
-        .select('*')
-        .eq('session_id', session.id)
-        .eq('trainee_id', traineeId)
-        .maybeSingle()
-
-      if (evalData) {
-        setEvaluationData(evalData)
-        setEvalForm({
-          q_org_documents: evalData.q_org_documents || 0,
-          q_org_accueil: evalData.q_org_accueil || 0,
-          q_org_locaux: evalData.q_org_locaux || 0,
-          q_org_materiel: evalData.q_org_materiel || 0,
-          q_contenu_organisation: evalData.q_contenu_organisation || 0,
-          q_contenu_supports: evalData.q_contenu_supports || 0,
-          q_contenu_duree: evalData.q_contenu_duree || 0,
-          q_contenu_programme: evalData.q_contenu_programme || 0,
-          q_formateur_pedagogie: evalData.q_formateur_pedagogie || 0,
-          q_formateur_expertise: evalData.q_formateur_expertise || 0,
-          q_formateur_progression: evalData.q_formateur_progression || 0,
-          q_formateur_moyens: evalData.q_formateur_moyens || 0,
-          q_global_adequation: evalData.q_global_adequation || 0,
-          q_global_competences: evalData.q_global_competences || 0,
-          would_recommend: evalData.would_recommend || false,
-          comment_general: evalData.comment_general || '',
-          comment_projet: evalData.comment_projet || '',
-        })
-      }
+      // Setup evaluation data
+      setEvaluationData(evaluation)
+      setEvalForm({
+        q_org_documents: evaluation?.q_org_documents || 0,
+        q_org_accueil: evaluation?.q_org_accueil || 0,
+        q_org_locaux: evaluation?.q_org_locaux || 0,
+        q_org_materiel: evaluation?.q_org_materiel || 0,
+        q_contenu_organisation: evaluation?.q_contenu_organisation || 0,
+        q_contenu_supports: evaluation?.q_contenu_supports || 0,
+        q_contenu_duree: evaluation?.q_contenu_duree || 0,
+        q_contenu_programme: evaluation?.q_contenu_programme || 0,
+        q_formateur_pedagogie: evaluation?.q_formateur_pedagogie || 0,
+        q_formateur_expertise: evaluation?.q_formateur_expertise || 0,
+        q_formateur_progression: evaluation?.q_formateur_progression || 0,
+        q_formateur_moyens: evaluation?.q_formateur_moyens || 0,
+        q_global_adequation: evaluation?.q_global_adequation || 0,
+        q_global_competences: evaluation?.q_global_competences || 0,
+        would_recommend: evaluation?.would_recommend || false,
+        comment_general: evaluation?.comment_general || '',
+        comment_projet: evaluation?.comment_projet || '',
+      })
 
       // Determine current step
-      if (!infoData?.filled_at) {
+      if (!info_sheet?.filled_at) {
         setCurrentStep('info_sheet')
       } else if (!allAttendanceDone(attMap)) {
         setCurrentStep('attendance')
-      } else if (isLastDay() && !evalData?.questionnaire_submitted) {
+      } else if (isLastDay() && !evaluation?.questionnaire_submitted) {
         setCurrentStep('evaluation')
       } else {
         setCurrentStep('thank_you')
       }
 
-      setLoading(false)
+      setCodeLoading(false)
     } catch (err) {
-      console.error(err)
-      setError('Erreur lors du chargement des données')
-      setLoading(false)
+      console.error('Load profile error:', err)
+      setError('Erreur lors du chargement')
+      setCodeLoading(false)
     }
   }
 
@@ -180,31 +243,27 @@ export default function TraineePortal() {
     setLoading(true)
 
     try {
-      // Update trainee basic info
-      const { error: traineeErr } = await supabase
-        .from('trainees')
-        .update({
+      // Update trainee via RPC
+      const { data: traineeRes } = await supabase.rpc('public_update_trainee', {
+        p_portal_token: portalToken,
+        p_data: {
           first_name: infoForm.first_name,
           last_name: infoForm.last_name,
           email: infoForm.email,
           birth_date: infoForm.birth_date || null,
           social_security_number: infoForm.ssn_refused ? null : infoForm.ssn,
           refused_ssn: infoForm.ssn_refused,
           csp: infoForm.csp,
           job_title: infoForm.job_title,
-          updated_at: new Date().toISOString()
-        })
-        .eq('id', selectedTrainee.id)
+        }
+      })
 
-      if (traineeErr) throw traineeErr
+      if (!traineeRes?.success) throw new Error('Trainee update failed')
 
-      // Upsert info sheet
-      const { error: infoErr } = await supabase
-        .from('trainee_info_sheets')
-        .upsert({
-          session_id: session.id,
-          trainee_id: selectedTrainee.id,
+      // Upsert info sheet via RPC
+      const { data: infoRes } = await supabase.rpc('public_upsert_info_sheet', {
+        p_portal_token: portalToken,
+        p_data: {
           email: infoForm.email,
           ssn: infoForm.ssn_refused ? null : infoForm.ssn,
           ssn_refused: infoForm.ssn_refused,
@@ -213,12 +272,11 @@ export default function TraineePortal() {
           csp: infoForm.csp,
           job_title: infoForm.job_title,
           rgpd_consent: infoForm.rgpd_consent,
-          filled_at: new Date().toISOString(),
-          filled_online: true
-        }, { onConflict: 'session_id,trainee_id' })
+        }
+      })
 
-      if (infoErr) throw infoErr
+      if (!infoRes?.success) throw new Error('Info sheet update failed')
 
       setInfoSheet({ ...infoSheet, filled_at: new Date().toISOString() })
       setCurrentStep('attendance')
     } catch (err) {
@@ -235,17 +293,14 @@ export default function TraineePortal() {
     setLoading(true)
 
     try {
-      const { error } = await supabase
-        .from('attendance_halfdays')
-        .upsert({
-          session_id: session.id,
-          trainee_id: selectedTrainee.id,
-          date: dateStr,
-          [period]: true,
-          validated_at: new Date().toISOString()
-        }, { onConflict: 'session_id,trainee_id,date' })
+      const { data } = await supabase.rpc('public_upsert_attendance', {
+        p_portal_token: portalToken,
+        p_date: dateStr,
+        p_morning: period === 'morning' ? true : null,
+        p_afternoon: period === 'afternoon' ? true : null
+      })
 
-      if (error) throw error
+      if (!data?.success) throw new Error('Attendance update failed')
 
       const newAttendance = { ...attendanceData, [key]: true }
       setAttendanceData(newAttendance)
@@ -269,12 +324,9 @@ export default function TraineePortal() {
     setLoading(true)
 
     try {
-      const { error } = await supabase
-        .from('trainee_evaluations')
-        .upsert({
-          session_id: session.id,
-          trainee_id: selectedTrainee.id,
+      const { data } = await supabase.rpc('public_upsert_evaluation', {
+        p_portal_token: portalToken,
+        p_data: {
           q_org_documents: evalForm.q_org_documents,
           q_org_accueil: evalForm.q_org_accueil,
           q_org_locaux: evalForm.q_org_locaux,
@@ -291,12 +343,11 @@ export default function TraineePortal() {
           would_recommend: evalForm.would_recommend,
           comment_general: evalForm.comment_general,
           comment_projet: evalForm.comment_projet,
-          questionnaire_submitted: true,
-          submitted_at: new Date().toISOString(),
-          submitted_online: true
-        }, { onConflict: 'session_id,trainee_id' })
+        }
+      })
 
-      if (error) throw error
+      if (!data?.success) throw new Error('Evaluation update failed')
 
       setEvaluationData({ ...evaluationData, questionnaire_submitted: true })
       setCurrentStep('thank_you')
@@ -349,6 +400,59 @@ export default function TraineePortal() {
     )
   }
 
+  // ============== STEP: CODE VERIFICATION ==============
+  if (currentStep === 'code') {
+    return (
+      <div className="min-h-screen bg-gray-50 py-8 px-4">
+        <div className="max-w-md mx-auto">
+          <div className="bg-white rounded-xl shadow-lg p-6">
+            <div className="text-center mb-6">
+              <KeyRound className="w-12 h-12 text-purple-600 mx-auto mb-2" />
+              <h1 className="text-xl font-bold text-gray-900">Code d'accès</h1>
+              <p className="text-gray-600 mt-1">
+                {selectedTrainee?.first_name} {selectedTrainee?.last_name?.toUpperCase()}
+              </p>
+            </div>
+
+            <div className="space-y-4">
+              <div>
+                <label className="block text-sm font-medium text-gray-700 mb-1">
+                  Saisissez votre code (6 chiffres)
+                </label>
+                <input
+                  type="text"
+                  inputMode="numeric"
+                  value={codeInput}
+                  onChange={(e) => setCodeInput(formatCodeInput(e.target.value))}
+                  placeholder="XXX-XXX"
+                  className="input w-full text-center text-2xl font-mono tracking-widest"
+                  maxLength={7}
+                  autoFocus
+                />
+                <p className="text-xs text-gray-500 mt-1 text-center">
+                  Code communiqué par votre formateur
+                </p>
+              </div>
+
+              {codeError && (
+                <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm flex items-center gap-2">
+                  <AlertCircle className="w-4 h-4 flex-shrink-0" />
+                  <span>{codeError}</span>
+                </div>
+              )}
+
+              <div className="flex gap-3">
+                <button
+                  onClick={() => { setCurrentStep('select'); setSelectedTrainee(null); setCodeError(null) }}
+                  className="flex-1 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
+                >
+                  Retour
+                </button>
+                <button
+                  onClick={handleVerifyCode}
+                  disabled={codeLoading || codeInput.replace(/\D/g, '').length !== 6}
+                  className="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center justify-center gap-2"
+                >
+                  {codeLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <ShieldCheck className="w-5 h-5" />}
+                  {codeLoading ? 'Vérification...' : 'Valider'}
+                </button>
+              </div>
+            </div>
+          </div>
+        </div>
+      </div>
+    )
+  }
+
   // ============== STEP: SELECT TRAINEE ==============
   if (currentStep === 'select') {
     return (
@@ -370,13 +474,21 @@ export default function TraineePortal() {
               {trainees.map(trainee => (
                 <button
                   key={trainee.id}
                   onClick={() => handleSelectTrainee(trainee)}
-                  className="w-full p-4 text-left border rounded-lg hover:bg-blue-50 hover:border-blue-300 transition flex items-center gap-3"
+                  disabled={trainee.locked}
+                  className={`w-full p-4 text-left border rounded-lg transition flex items-center gap-3 ${
+                    trainee.locked
+                      ? 'bg-red-50 border-red-200 cursor-not-allowed opacity-75'
+                      : 'hover:bg-blue-50 hover:border-blue-300'
+                  }`}
                 >
                   <User className="w-5 h-5 text-gray-400" />
-                  <span className="font-medium">
+                  <span className="font-medium flex-1">
                     {trainee.first_name} {trainee.last_name?.toUpperCase()}
                   </span>
+                  {trainee.locked && (
+                    <Lock className="w-4 h-4 text-red-500" title="Compte bloqué" />
+                  )}
                 </button>
               ))}
             </div>
diff --git a/src/pages/public/Reclamation.jsx b/src/pages/public/Reclamation.jsx
index 1234567..abcdefg 100644
--- a/src/pages/public/Reclamation.jsx
+++ b/src/pages/public/Reclamation.jsx
@@ -1,6 +1,6 @@
 import { useState } from 'react'
 import { supabase } from '../../lib/supabase'
-import { MessageSquare, Send, CheckCircle, AlertCircle, Loader2 } from 'lucide-react'
+import { MessageSquare, Send, CheckCircle, AlertCircle, Loader2, Search } from 'lucide-react'
 import { format, parseISO } from 'date-fns'
 import { fr } from 'date-fns/locale'
 
@@ -10,8 +10,14 @@ export default function Reclamation() {
   const [error, setError] = useState(null)
   const [sessionRef, setSessionRef] = useState('')
   const [sessionInfo, setSessionInfo] = useState(null)
-  const [form, setForm] = useState({ fullName: '', email: '', phone: '', company: '', message: '' })
+  const [form, setForm] = useState({
+    fullName: '',
+    email: '',
+    phone: '',
+    company: '',
+    message: '',
+    honeypot: '' // Anti-bot field
+  })
   const [formErrors, setFormErrors] = useState({})
 
   const formatDate = (dateStr) => {
@@ -26,24 +32,22 @@ export default function Reclamation() {
     if (!sessionRef.trim()) { setError('Veuillez saisir une référence de session'); return }
     setLoading(true)
     setError(null)
+
     try {
-      const ref = sessionRef.trim().toUpperCase()
-      const fullRef = ref.startsWith('SES-') ? ref : `SES-${ref}`
-
-      const { data, error: dbError } = await supabase
-        .from('sessions')
-        .select('id, reference, start_date, end_date, courses(title)')
-        .eq('reference', fullRef)
-        .single()
-
-      if (dbError || !data) {
-        setError('Session non trouvée. Vérifiez la référence.')
+      const { data, error: rpcError } = await supabase.rpc('public_verify_reclamation_session', {
+        p_reference: sessionRef.trim()
+      })
+
+      if (rpcError) {
+        setError('Erreur de connexion')
+        setLoading(false)
+        return
+      }
+
+      if (!data?.success) {
+        setError('Session non trouvée. Vérifiez la référence sur votre convocation.')
         setLoading(false)
         return
       }
 
-      setSessionInfo({
-        id: data.id,
-        reference: data.reference,
-        title: data.courses?.title,
-        start_date: data.start_date,
-        end_date: data.end_date
-      })
+      setSessionInfo(data.session)
       setStep('form')
     } catch (err) {
       console.error(err)
@@ -72,21 +76,22 @@ export default function Reclamation() {
     setLoading(true)
     setError(null)
+
     try {
-      const { error: insertError } = await supabase
-        .from('non_conformites')
-        .insert({
-          source: 'reclamation',
-          session_id: sessionInfo.id,
-          title: `Réclamation - ${form.fullName}`,
-          description: `**Réclamant:** ${form.fullName} <${form.email}>\n**Téléphone:** ${form.phone || 'Non renseigné'}\n**Entreprise:** ${form.company || 'Non renseignée'}\n**Session:** ${sessionInfo.reference} - ${sessionInfo.title || 'N/A'}\n\n**Message:**\n${form.message}`,
-          status: 'open',
-          severity: 'minor'
-        })
-
-      if (insertError) throw insertError
+      const { data, error: rpcError } = await supabase.rpc('public_submit_reclamation', {
+        p_reference: sessionInfo.reference,
+        p_full_name: form.fullName.trim(),
+        p_email: form.email.trim(),
+        p_phone: form.phone.trim() || null,
+        p_company: form.company.trim() || null,
+        p_message: form.message.trim(),
+        p_honeypot: form.honeypot || null
+      })
+
+      if (rpcError) {
+        setError('Erreur lors de l\'envoi')
+        setLoading(false)
+        return
+      }
+
+      if (!data?.success) {
+        setError(data?.message || 'Erreur lors de l\'envoi')
+        setLoading(false)
+        return
+      }
 
       setStep('success')
     } catch (err) {
@@ -111,6 +116,7 @@ export default function Reclamation() {
             <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Référence de la session</label>
               <div className="relative">
                 <input
                   type="text"
                   value={sessionRef}
@@ -119,6 +125,7 @@ export default function Reclamation() {
                   className="input w-full pr-10"
                   autoFocus
                 />
+                <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
               </div>
               <p className="text-xs text-gray-500 mt-1">Cette référence figure sur votre convocation ou attestation</p>
             </div>
@@ -154,10 +161,18 @@ export default function Reclamation() {
           <div className="mb-4 p-3 bg-blue-50 rounded-lg text-sm">
-            <p><strong>Session :</strong> {sessionInfo?.reference}</p>
-            <p><strong>Formation :</strong> {sessionInfo?.title || 'N/A'}</p>
-            <p><strong>Dates :</strong> {formatDate(sessionInfo?.start_date)} - {formatDate(sessionInfo?.end_date)}</p>
+            <p><strong>Formation :</strong> {sessionInfo?.title || 'N/A'}</p>
+            <p><strong>Dates :</strong> {formatDate(sessionInfo?.start_date)} - {formatDate(sessionInfo?.end_date)}</p>
           </div>
 
           <form onSubmit={handleSubmit} className="space-y-4">
+            {/* Honeypot - hidden from users */}
+            <input
+              type="text"
+              name="website"
+              value={form.honeypot}
+              onChange={(e) => setForm({ ...form, honeypot: e.target.value })}
+              style={{ display: 'none' }}
+              tabIndex={-1}
+              autoComplete="off"
+            />
+
             <div>
               <label className="block text-sm font-medium text-gray-700 mb-1">Votre nom complet *</label>
               <input
diff --git a/src/pages/SessionDetail.jsx b/src/pages/SessionDetail.jsx
index 1234567..abcdefg 100644
--- a/src/pages/SessionDetail.jsx
+++ b/src/pages/SessionDetail.jsx
@@ -7,7 +7,7 @@ import {
   ArrowLeft, Calendar, MapPin, Users, Clock, FileText, QrCode, UserPlus, UserMinus,
   Download, CheckCircle, AlertCircle, Copy, ExternalLink, X, Edit, Trash2, Save,
   FileSignature, Send, Upload, Eye, Star, ThumbsUp, ClipboardCheck, UserCheck,
-  HelpCircle, Home, Target, Sun, Moon, Plus, ChevronDown, Search, LogOut
+  HelpCircle, Home, Target, Sun, Moon, Plus, ChevronDown, Search, LogOut, KeyRound, Lock, RefreshCw, Loader2
 } from 'lucide-react'
 import { format, eachDayOfInterval, parseISO, differenceInDays } from 'date-fns'
 import { fr } from 'date-fns/locale'
@@ -100,6 +100,10 @@ export default function SessionDetail() {
   const [sessionCosts, setSessionCosts] = useState([])
   const [showAddCost, setShowAddCost] = useState(false)
 
+  // Access codes management
+  const [traineeAccessCodes, setTraineeAccessCodes] = useState({})
+  const [regeneratingCode, setRegeneratingCode] = useState(null)
+
   useEffect(() => {
     const loadData = async () => {
       await Promise.all([fetchSessions(), fetchTrainees(), fetchTrainers(), fetchClients(), fetchOrganization()])
@@ -119,6 +123,7 @@ export default function SessionDetail() {
       setSession(found)
       setEditForm(found)
       generateQRCode(found.attendance_token)
+      loadAccessCodes(found.id)
 
       // Load additional data
       await Promise.all([
@@ -130,6 +135,52 @@ export default function SessionDetail() {
     loadData()
   }, [id, sessions])
 
+  const loadAccessCodes = async (sessionId) => {
+    try {
+      const { data, error } = await supabase
+        .from('session_trainees')
+        .select('trainee_id, access_code, access_code_attempts, access_code_locked')
+        .eq('session_id', sessionId)
+
+      if (!error && data) {
+        const codes = {}
+        data.forEach(st => {
+          codes[st.trainee_id] = {
+            code: st.access_code,
+            attempts: st.access_code_attempts || 0,
+            locked: st.access_code_locked || false
+          }
+        })
+        setTraineeAccessCodes(codes)
+      }
+    } catch (err) {
+      console.error('Error loading access codes:', err)
+    }
+  }
+
+  const handleRegenerateCode = async (traineeId) => {
+    if (!session?.id) return
+    setRegeneratingCode(traineeId)
+
+    try {
+      const { data, error } = await supabase.rpc('reset_session_trainee_code', {
+        p_session_id: session.id,
+        p_trainee_id: traineeId
+      })
+
+      if (error) throw error
+
+      if (data?.success) {
+        setTraineeAccessCodes(prev => ({
+          ...prev,
+          [traineeId]: { code: data.new_code, attempts: 0, locked: false }
+        }))
+        toast.success('Code régénéré avec succès')
+      }
+    } catch (err) {
+      console.error('Error regenerating code:', err)
+      toast.error('Erreur lors de la régénération du code')
+    } finally {
+      setRegeneratingCode(null)
+    }
+  }
+
+  const formatAccessCode = (code) => {
+    if (!code || code.length !== 6) return '------'
+    return code.slice(0, 3) + '-' + code.slice(3)
+  }
+
   const generateQRCode = async (token) => {
     if (!token) return
     try {
@@ -1850,6 +1901,95 @@ export default function SessionDetail() {
           {/* QR Tab */}
           {activeTab === 'qr' && (
             <div className="space-y-6">
+              {/* Attendance Link */}
+              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
+                <h3 className="font-semibold text-lg mb-3">Lien d'émargement sécurisé</h3>
+                <div className="flex items-center gap-3">
+                  <input
+                    type="text"
+                    readOnly
+                    value={`${window.location.origin}/#/portail/${session.attendance_token}`}
+                    className="input flex-1 bg-white font-mono text-sm"
+                  />
+                  <button
+                    onClick={() => {
+                      navigator.clipboard.writeText(`${window.location.origin}/#/portail/${session.attendance_token}`)
+                      toast.success('Lien copié dans le presse-papier')
+                    }}
+                    className="btn btn-primary"
+                  >
+                    <Copy className="w-4 h-4" />
+                  </button>
+                </div>
+              </div>
+
+              {/* Security Warning */}
+              <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
+                <div className="flex items-start gap-3">
+                  <AlertCircle className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
+                  <div>
+                    <p className="font-medium text-amber-800">Codes d'accès confidentiels</p>
+                    <p className="text-sm text-amber-700 mt-1">
+                      Communiquez ces codes <strong>oralement</strong> aux stagiaires en début de formation.
+                      Ne les envoyez pas par email pour des raisons de sécurité.
+                    </p>
+                  </div>
+                </div>
+              </div>
+
+              {/* Trainee Flow */}
+              <div className="bg-gray-50 rounded-lg p-4">
+                <h4 className="font-medium text-sm text-gray-700 mb-3">Parcours du stagiaire :</h4>
+                <div className="flex items-center gap-2 flex-wrap text-sm">
+                  <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded font-medium">0. Code</span>
+                  <span className="text-gray-400">→</span>
+                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded">1. Fiche</span>
+                  <span className="text-gray-400">→</span>
+                  <span className="px-2 py-1 bg-green-100 text-green-700 rounded">2. Émargement</span>
+                  <span className="text-gray-400">→</span>
+                  <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded">3. Évaluation</span>
+                </div>
+              </div>
+
+              {/* Access Codes Table */}
+              <div>
+                <h3 className="font-semibold mb-3 flex items-center gap-2">
+                  <KeyRound className="w-5 h-5" />
+                  Codes d'accès stagiaires
+                </h3>
+                <div className="overflow-x-auto">
+                  <table className="w-full text-sm">
+                    <thead className="bg-gray-50">
+                      <tr>
+                        <th className="text-left p-3 font-medium">Stagiaire</th>
+                        <th className="text-center p-3 font-medium">Code</th>
+                        <th className="text-center p-3 font-medium">Tentatives</th>
+                        <th className="text-center p-3 font-medium">Statut</th>
+                        <th className="text-center p-3 font-medium">Action</th>
+                      </tr>
+                    </thead>
+                    <tbody className="divide-y">
+                      {sessionTrainees.map(trainee => {
+                        const codeInfo = traineeAccessCodes[trainee.id] || {}
+                        const isLocked = codeInfo.locked
+                        const attempts = codeInfo.attempts || 0
+
+                        return (
+                          <tr key={trainee.id} className={isLocked ? 'bg-red-50' : ''}>
+                            <td className="p-3">{trainee.first_name} {trainee.last_name?.toUpperCase()}</td>
+                            <td className="p-3 text-center">
+                              <span className="font-mono text-lg bg-purple-100 text-purple-800 px-3 py-1 rounded">
+                                {formatAccessCode(codeInfo.code)}
+                              </span>
+                            </td>
+                            <td className="p-3 text-center">
+                              <span className={`px-2 py-1 rounded text-xs ${attempts >= 3 ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-600'}`}>
+                                {attempts}/5
+                              </span>
+                            </td>
+                            <td className="p-3 text-center">
+                              {isLocked ? (
+                                <span className="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded text-xs">
+                                  <Lock className="w-3 h-3" />Bloqué
+                                </span>
+                              ) : (
+                                <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded text-xs">
+                                  <CheckCircle className="w-3 h-3" />Actif
+                                </span>
+                              )}
+                            </td>
+                            <td className="p-3 text-center">
+                              <button
+                                onClick={() => handleRegenerateCode(trainee.id)}
+                                disabled={regeneratingCode === trainee.id}
+                                className={`inline-flex items-center gap-1 px-3 py-1.5 rounded text-xs font-medium transition ${
+                                  isLocked
+                                    ? 'bg-red-600 text-white hover:bg-red-700'
+                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
+                                }`}
+                                title={isLocked ? 'Débloquer et régénérer le code' : 'Régénérer le code'}
+                              >
+                                {regeneratingCode === trainee.id ? (
+                                  <Loader2 className="w-3 h-3 animate-spin" />
+                                ) : (
+                                  <RefreshCw className="w-3 h-3" />
+                                )}
+                                {isLocked ? 'Débloquer' : 'Régénérer'}
+                              </button>
+                            </td>
+                          </tr>
+                        )
+                      })}
+                    </tbody>
+                  </table>
+                </div>
+              </div>
+
               {/* Existing QR content... */}
             </div>
           )}
